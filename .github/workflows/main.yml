name: Build Tellesoft Office (Linux + Windows MSI)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]name: Build Tellesoft Office MSI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install required build tools
        run: |
          choco install strawberryperl --no-progress -y
          choco install nasm --no-progress -y
          choco install jdk17 --no-progress -y
          choco install make --no-progress -y
        shell: powershell

      - name: Configure Visual Studio Build Environment
        run: |
          echo "call \"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat\"" > vsenv.bat
          echo "bash autogen.sh" >> vsenv.bat
          call vsenv.bat
        shell: cmd

      - name: Build LibreOffice (Tellesoft Office)
        run: |
          echo "call \"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat\"" > build.bat
          echo "make build-nocheck" >> build.bat
          call build.bat
        shell: cmd

      - name: Generate MSI installer
        run: |
          echo "call \"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat\"" > msi.bat
          echo "make instsetoo_native" >> msi.bat
          call msi.bat
        shell: cmd

      - name: Upload TellesoftOffice.msi
        uses: actions/upload-artifact@v4
        with:
          name: TellesoftOffice-Installer
          path: workdir/instsetoo_native/install/en-US/*.msi


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            bison \
            flex \
            unzip \
            zip \
            tar \
            m4 \
            default-jdk \
            python3 \
            python3-pip \
            nasm \
            libgtk-3-dev \
            libcups2-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxss-dev \
            libglu1-mesa-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libkrb5-dev \
            mingw-w64 \
            wine64

      - name: Prepare autogen.input
        run: |
          echo '--with-theme=colibre' > autogen.input
          echo '--disable-firebird-sdbc' >> autogen.input
          echo '--disable-ccache' >> autogen.input
          echo '--enable-release-build=yes' >> autogen.input
          echo '--with-java' >> autogen.input
          echo '--with-package-format=msi' >> autogen.input
          echo '--host=x86_64-w64-mingw32' >> autogen.input
          echo '--build=x86_64-pc-linux-gnu' >> autogen.input

      - name: Run autogen.sh
        run: ./autogen.sh

      - name: Build Linux version
        run: make build-nocheck

      - name: Build Windows MSI
        run: make instsetoo_native

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TellesoftOffice-Linux
          path: instdir/

      - name: Upload Windows MSI
        uses: actions/upload-artifact@v4
        with:
          name: TellesoftOffice-Windows
          path: workdir/instsetoo_native/install/en-US/*.msi
