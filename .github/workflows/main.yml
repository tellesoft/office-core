name: Build Tellesoft Office MSI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Verify preinstalled dependencies
        run: |
          perl -v
          python --version
          where nasm
          where javac
          echo %JAVA_HOME%
        shell: cmd

      - name: Install Cygwin for bash
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            bash
            unzip
            zip
            tar
            bison
            flex
            autoconf
            automake
            m4
            pkg-config
            dos2unix

      - name: Convert all *.sh scripts to Unix (LF) format
        run: |
          C:\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && find . -type f -name '*.sh' -exec dos2unix {} \;"
        shell: cmd

      - name: Prepare autogen.input
        run: |
          echo '--with-theme=colibre' > autogen.input
          echo '--disable-firebird-sdbc' >> autogen.input
          echo '--disable-ccache' >> autogen.input
          echo "--with-jdk-home=$JAVA_HOME" >> autogen.input
          echo '--with-visual-studio=2022' >> autogen.input
          echo '--with-windows-sdk=10.0' >> autogen.input
          echo '--enable-release-build=yes' >> autogen.input
        shell: bash

      - name: Run autogen.sh
        run: |
          C:\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && ./autogen.sh"
        shell: cmd

      - name: Build LibreOffice (Tellesoft Office)
        run: |
          C:\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && make build-nocheck"
        shell: cmd

      - name: Generate MSI installer
        run: |
          C:\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && make instsetoo_native"
        shell: cmd

      - name: Collect MSI output
        run: |
          mkdir output
          copy workdir\instsetoo_native\install\en-US\LibreOffice_*.msi output\TellesoftOffice.msi
        shell: cmd

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: TellesoftOffice
          path: output/TellesoftOffice.msi
