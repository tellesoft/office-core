name: Build Tellesoft Office MSI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Install dependencies (Perl, Python, NASM, JDK)
        shell: powershell
        run: |
          choco install strawberryperl --no-progress --yes
          choco install python3 --no-progress --yes
          choco install nasm --no-progress --yes
          choco install jdk17 --no-progress --yes
          choco install 7zip --no-progress --yes
          refreshenv

      - name: Add JDK to environment
        run: |
          echo "JAVA_HOME=C:\\Program Files\\Eclipse Adoptium\\jdk-17*" >> $env:GITHUB_ENV
        shell: powershell

      - name: Install Cygwin for bash shell
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            bash
            unzip
            zip
            tar
            bison
            flex
            autoconf
            automake
            m4
            pkg-config

      - name: Prepare autogen.input
        run: |
          echo '--with-theme=colibre' > autogen.input
          echo '--disable-firebird-sdbc' >> autogen.input
          echo '--disable-ccache' >> autogen.input
          echo '--with-jdk-home="C:/Program Files/Eclipse Adoptium/jdk-17"' >> autogen.input
          echo '--with-visual-studio=2022' >> autogen.input
          echo '--with-windows-sdk=10.0' >> autogen.input
          echo '--enable-release-build=yes' >> autogen.input
        shell: bash

      - name: Run autogen.sh
        run: |
          C:\tools\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && ./autogen.sh"
        shell: cmd

      - name: Build LibreOffice (Tellesoft Office)
        run: |
          C:\tools\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && make build-nocheck"
        shell: cmd

      - name: Generate MSI installer
        run: |
          C:\tools\cygwin\bin\bash.exe -lc "cd $(cygpath -u '${{ github.workspace }}') && make instsetoo_native"
        shell: cmd

      - name: Collect MSI output
        run: |
          mkdir output
          copy workdir\instsetoo_native\install\en-US\LibreOffice_*.msi output\TellesoftOffice.msi
        shell: cmd

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: TellesoftOffice
          path: output/TellesoftOffice.msi
